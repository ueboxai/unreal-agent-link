# UAL_CommandHandler 拆分迁移指南

## 文件结构

```
Source/UnrealAgentLink/
├── Public/
│   ├── UAL_CommandHandler.h      # 主入口（保留）
│   ├── UAL_CommandUtils.h        # ✅ 已完成 - 公共工具函数
│   ├── UAL_ActorCommands.h       # ✅ 已完成 - Actor 命令声明
│   ├── UAL_SystemCommands.h      # ✅ 已完成 - 系统命令声明
│   ├── UAL_EditorCommands.h      # ✅ 已完成 - 编辑器命令声明
│   ├── UAL_LevelCommands.h       # ✅ 已完成 - 关卡命令声明
│   └── UAL_BlueprintCommands.h   # ✅ 已完成 - 蓝图命令声明
├── Private/
│   ├── UAL_CommandHandler.cpp    # 待精简为入口点
│   ├── UAL_CommandUtils.cpp      # ✅ 已完成 - 公共工具函数实现 (1316行)
│   ├── UAL_ActorCommands.cpp     # ✅ 框架已创建 - 待迁移实现
│   ├── UAL_SystemCommands.cpp    # ✅ 框架已创建 - 待迁移实现
│   ├── UAL_EditorCommands.cpp    # ✅ 框架已创建 - 待迁移实现
│   ├── UAL_LevelCommands.cpp     # ✅ 框架已创建 - 待迁移实现
│   └── UAL_BlueprintCommands.cpp # ✅ 框架已创建 - 待迁移实现
```

---

## 迁移映射表

### UAL_SystemCommands.cpp
| 函数 | 原始行号 |
|------|----------|
| Handle_RunPython | 1631-1653 |
| Handle_ExecConsole | 1655-1678 |
| Handle_GetPerformanceStats | 1680-1719 |

### UAL_LevelCommands.cpp
| 函数 | 原始行号 |
|------|----------|
| Handle_QueryAssets | 1721-1981 |

### UAL_EditorCommands.cpp
| 函数 | 原始行号 |
|------|----------|
| Handle_TakeScreenshot | 1984-2142 |
| Handle_GetProjectInfo | 2144-2148 |
| BuildProjectInfo | 2150-2278 |

### UAL_BlueprintCommands.cpp
| 函数 | 原始行号 |
|------|----------|
| Handle_CreateBlueprint | 2279-2512 |

### UAL_ActorCommands.cpp
| 函数 | 原始行号 |
|------|----------|
| SpawnSingleActor | 2514-2654 |
| Handle_SpawnActor | 2656-2730 |
| Handle_SpawnActorsBatch | 2732-2744 |
| DestroySingleActor | 2746-2788 |
| Handle_DestroyActor | 2790-2892 |
| Handle_DestroyActorsBatch | 2894-2941 |
| Handle_GetActorInfo | 2943-3005 |
| Handle_GetActor | 3007-3089 |
| Handle_InspectActor | 3091-3170 |
| Handle_SetProperty | 3172-3330 |
| Handle_SetTransformUnified | 3332-3529 |

---

## 迁移步骤

### 1. 复制函数实现
从 `UAL_CommandHandler.cpp` 复制对应行号的函数到各分类文件，注意：
- 将 `FUAL_CommandHandler::` 改为对应类名如 `FUAL_ActorCommands::`
- 将工具函数调用如 `GetTargetWorld()` 改为 `UAL_CommandUtils::GetTargetWorld()`
- 将 `SendResponse/SendError` 改为 `UAL_CommandUtils::SendResponse/SendError`

### 2. 常用替换规则
```cpp
// 原始（匿名命名空间内）
GetTargetWorld()
FindActorByLabel(World, Name)
GetActorFriendlyName(Actor)
BuildActorInfo(Actor)
ResolveTargetsToActors(...)
ReadVector(...)
MakeVectorJson(...)
SendResponse(...)
SendError(...)

// 替换为
UAL_CommandUtils::GetTargetWorld()
UAL_CommandUtils::FindActorByLabel(World, Name)
UAL_CommandUtils::GetActorFriendlyName(Actor)
UAL_CommandUtils::BuildActorInfo(Actor)
UAL_CommandUtils::ResolveTargetsToActors(...)
UAL_CommandUtils::ReadVector(...)
UAL_CommandUtils::MakeVectorJson(...)
UAL_CommandUtils::SendResponse(...)
UAL_CommandUtils::SendError(...)
```

### 3. 更新 UAL_CommandHandler.cpp
完成迁移后，将 `RegisterCommands()` 改为调用各分类的注册函数：

```cpp
#include "UAL_ActorCommands.h"
#include "UAL_SystemCommands.h"
#include "UAL_EditorCommands.h"
#include "UAL_LevelCommands.h"
#include "UAL_BlueprintCommands.h"

void FUAL_CommandHandler::RegisterCommands()
{
    FUAL_ActorCommands::RegisterCommands(CommandMap);
    FUAL_SystemCommands::RegisterCommands(CommandMap);
    FUAL_EditorCommands::RegisterCommands(CommandMap);
    FUAL_LevelCommands::RegisterCommands(CommandMap);
    FUAL_BlueprintCommands::RegisterCommands(CommandMap);
}
```

### 4. 删除已迁移代码
从 `UAL_CommandHandler.cpp` 中删除：
- 匿名命名空间内的所有辅助函数（第 82-1463 行）
- 各 Handle_* 函数实现（已迁移到分类文件）
- 保留：构造函数、ProcessMessage、RegisterCommands（精简版）、Handle_Response、SendResponse、SendError

---

## 编译验证
迁移完成后运行 UE 编译验证：
```
# 在 UE 编辑器中重新编译插件
# 或使用命令行：
UnrealEditor.exe -project=YourProject.uproject -run=CompilePlugin -plugin=UnrealAgentLink
```
